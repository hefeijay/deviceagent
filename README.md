# DeviceAgent - è®¾å¤‡ç®¡ç†AgentæœåŠ¡

åŸºäº LangGraph å’Œ FastAPI çš„æ™ºèƒ½è®¾å¤‡ç®¡ç†ç³»ç»Ÿï¼Œç”¨äºæ§åˆ¶å’Œç®¡ç†å…»æ®–åœºæ™¯ä¸­çš„å„ç±»è®¾å¤‡ã€‚

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

DeviceAgent æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„è®¾å¤‡ç®¡ç†AgentæœåŠ¡ï¼Œä¸»è¦ç”¨äºï¼š

- **è®¾å¤‡æ§åˆ¶**ï¼šå–‚é£Ÿæœºã€æ‘„åƒå¤´ã€ä¼ æ„Ÿå™¨ç­‰è®¾å¤‡çš„æ™ºèƒ½æ§åˆ¶
- **ä¸“å®¶å’¨è¯¢**ï¼šé›†æˆå¤–éƒ¨å…»æ®–ä¸“å®¶ç³»ç»Ÿï¼Œæä¾›æ•°æ®æŸ¥è¯¢å’Œåˆ†æå»ºè®®
- **æ„å›¾è¯†åˆ«**ï¼šè‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œè·¯ç”±åˆ°å¯¹åº”è®¾å¤‡èŠ‚ç‚¹
- **å¼‚æ­¥å¤„ç†**ï¼šåŸºäºFastAPIçš„å¼‚æ­¥æ¶æ„ï¼Œé«˜æ€§èƒ½å¤„ç†

## ğŸ“ é¡¹ç›®ç»“æ„

```
deviceagent/
â”œâ”€â”€ api/                    # FastAPIæ¥å£å±‚
â”‚   â”œâ”€â”€ app.py             # ä¸»åº”ç”¨
â”‚   â””â”€â”€ device_api.py      # è®¾å¤‡ç®¡ç†è·¯ç”±
â”œâ”€â”€ config/                 # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ settings.py        # é…ç½®æ–‡ä»¶
â”œâ”€â”€ enums/                  # æšä¸¾å®šä¹‰
â”‚   â”œâ”€â”€ device_type.py     # è®¾å¤‡ç±»å‹
â”‚   â”œâ”€â”€ device_node.py     # èŠ‚ç‚¹æšä¸¾
â”‚   â””â”€â”€ operation_status.py # æ“ä½œçŠ¶æ€
â”œâ”€â”€ graph/                  # LangGraphå·¥ä½œæµ
â”‚   â”œâ”€â”€ builder.py         # å·¥ä½œæµæ„å»ºå™¨
â”‚   â”œâ”€â”€ nodes.py           # æ ¸å¿ƒèŠ‚ç‚¹
â”‚   â”œâ”€â”€ device_nodes.py    # è®¾å¤‡èŠ‚ç‚¹
â”‚   â””â”€â”€ schemas.py         # Stateå®šä¹‰
â”œâ”€â”€ llms/                   # LLMç®¡ç†
â”‚   â””â”€â”€ llm_manager.py     # LLMç®¡ç†å™¨
â”œâ”€â”€ prompts/                # æç¤ºè¯åº“
â”‚   â”œâ”€â”€ expert_gate_prompt.md
â”‚   â”œâ”€â”€ device_router_prompt.md
â”‚   â”œâ”€â”€ feeder_agent_prompt.md
â”‚   â”œâ”€â”€ camera_agent_prompt.md
â”‚   â””â”€â”€ sensor_agent_prompt.md
â”œâ”€â”€ services/               # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ expert_service.py  # å¤–éƒ¨ä¸“å®¶æœåŠ¡
â”‚   â”œâ”€â”€ feeder_service.py  # å–‚é£ŸæœºæœåŠ¡
â”‚   â”œâ”€â”€ camera_service.py  # æ‘„åƒå¤´æœåŠ¡
â”‚   â””â”€â”€ sensor_service.py  # ä¼ æ„Ÿå™¨æœåŠ¡
â”œâ”€â”€ tools/                  # å·¥å…·å±‚
â”‚   â”œâ”€â”€ tool_provider.py   # å·¥å…·æ³¨å†Œå™¨
â”‚   â”œâ”€â”€ feeder_tools.py    # å–‚é£Ÿæœºå·¥å…·
â”‚   â”œâ”€â”€ camera_tools.py    # æ‘„åƒå¤´å·¥å…·
â”‚   â”œâ”€â”€ sensor_tools.py    # ä¼ æ„Ÿå™¨å·¥å…·
â”‚   â””â”€â”€ expert_tools.py    # ä¸“å®¶å’¨è¯¢å·¥å…·
â”œâ”€â”€ utils/                  # å·¥å…·æ¨¡å—
â”‚   â””â”€â”€ logger.py          # æ—¥å¿—é…ç½®
â”œâ”€â”€ server.py              # æœåŠ¡å¯åŠ¨å…¥å£
â”œâ”€â”€ requirements.txt       # ä¾èµ–åˆ—è¡¨
â””â”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

## ğŸ”„ å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¯·æ±‚ 
  â†“
FastAPIæ¥å£ (/api/v1/chat)
  â†“
expert_gate_node (åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸“å®¶)
  â†“ æ˜¯ï¼šè°ƒç”¨ä¸“å®¶æœåŠ¡
  â†“ å¦ï¼šç›´æ¥ç»§ç»­
  â†“
device_router_node (è¯†åˆ«è®¾å¤‡ç±»å‹)
  â†“
è®¾å¤‡ä¸“å®¶èŠ‚ç‚¹ (feeder/camera/sensor)
  â†“ è°ƒç”¨å¯¹åº”å·¥å…·
  â†“
è¿”å›æ‰§è¡Œç»“æœ
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚

- Python 3.10+
- pip

### 2. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰
python -m venv venv
source venv/bin/activate  # Linux/Mac
# æˆ–
venv\Scripts\activate  # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ä½ çš„é…ç½®
vim .env
```

**å¿…éœ€é…ç½®ï¼š**
- `LLM_BASE_URL`: LLM APIåœ°å€
- `LLM_API_KEY`: LLM APIå¯†é’¥
- `EXPERT_API_BASE_URL`: å¤–éƒ¨ä¸“å®¶æœåŠ¡åœ°å€

**å¯é€‰é…ç½®ï¼š**
- `FEEDER_API_URL`: å–‚é£Ÿæœºç¡¬ä»¶APIåœ°å€
- `CAMERA_API_URL`: æ‘„åƒå¤´ç¡¬ä»¶APIåœ°å€
- `SENSOR_API_URL`: ä¼ æ„Ÿå™¨ç¡¬ä»¶APIåœ°å€

### 4. å¯åŠ¨æœåŠ¡

```bash
python server.py
```

æœåŠ¡å°†åœ¨ `http://0.0.0.0:8000` å¯åŠ¨ã€‚

### 5. è®¿é—®æ–‡æ¡£

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## ğŸ“¡ APIä½¿ç”¨ç¤ºä¾‹

### è®¾å¤‡æ§åˆ¶å¯¹è¯

```bash
curl -X POST "http://localhost:8000/api/v1/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æŸ¥çœ‹å–‚é£Ÿè®°å½•ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å–‚é£Ÿå¹¶å¸®æˆ‘å–‚ä¸€ä¸‹",
    "session_id": "test-session-123"
  }'
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "session_id": "test-session-123",
  "device_type": "feeder",
  "result": {
    "success": true,
    "messages": [
      "âœ… å–‚é£ŸæˆåŠŸï¼\n- å–‚é£Ÿé‡: 50g\n- å–‚é£Ÿæœº: default\n- æ‰§è¡Œæ—¶é—´: 2024-01-10 10:30:00"
    ]
  },
  "error": null
}
```

### æŸ¥çœ‹è®¾å¤‡çŠ¶æ€

```bash
curl "http://localhost:8000/api/v1/device/status"
```

### åˆ—å‡ºæ‰€æœ‰å·¥å…·

```bash
curl "http://localhost:8000/api/v1/device/tools"
```

## ğŸ”§ è®¾å¤‡ç±»å‹

### 1. å–‚é£Ÿæœº (Feeder)

**å…³é”®è¯ï¼š** å–‚é£Ÿã€æŠ•å–‚ã€é¥²æ–™

**å¯ç”¨å·¥å…·ï¼š**
- `feed_device`: ç«‹å³å–‚é£Ÿï¼ˆæŒ‰ä»½æ•°ï¼Œæ¯ä»½çº¦17gï¼‰

**ç¤ºä¾‹è¯·æ±‚ï¼š**
- "å¸®æˆ‘å–‚é£Ÿ50g" â†’ è‡ªåŠ¨è½¬æ¢ä¸º3ä»½
- "å–‚é£Ÿ2ä»½" â†’ ç›´æ¥å–‚é£Ÿ2ä»½ï¼ˆçº¦34gï¼‰
- "å–‚ä¸€ä¸‹" â†’ ä½¿ç”¨é»˜è®¤ä»½æ•°

**é…ç½®è¦æ±‚ï¼š**
- AIJ_FEEDER_USER: å–‚é£Ÿæœºè´¦å·
- AIJ_FEEDER_PASS: å–‚é£Ÿæœºå¯†ç 

**è¯¦ç»†é…ç½®**: å‚è§ [FEEDER_CONFIG.md](FEEDER_CONFIG.md)

### 2. æ‘„åƒå¤´ (Camera)

**å…³é”®è¯ï¼š** æ‹ç…§ã€è§†é¢‘ã€ç›‘æ§

**å¯ç”¨å·¥å…·ï¼š**
- `capture_image`: æ‹ç…§
- `start_streaming`: å¼€å¯è§†é¢‘æµ
- `stop_streaming`: å…³é—­è§†é¢‘æµ

**ç¤ºä¾‹è¯·æ±‚ï¼š**
- "æ‹å¼ ç…§ç‰‡çœ‹çœ‹"
- "æ‰“å¼€è§†é¢‘ç›‘æ§"
- "å…³é—­è§†é¢‘æµ"

### 3. ä¼ æ„Ÿå™¨ (Sensor)

**å…³é”®è¯ï¼š** æ¸©åº¦ã€PHå€¼ã€æº¶æ°§ã€ç›åº¦ã€æ°´è´¨

**å¯ç”¨å·¥å…·ï¼š**
- `read_sensor_data`: è¯»å–æŒ‡å®šä¼ æ„Ÿå™¨
- `read_all_sensors`: è¯»å–æ‰€æœ‰ä¼ æ„Ÿå™¨

**ç¤ºä¾‹è¯·æ±‚ï¼š**
- "æ£€æµ‹ä¸€ä¸‹æ°´æ¸©"
- "çœ‹çœ‹PHå€¼"
- "æ£€æµ‹ä¸€ä¸‹æ°´è´¨æƒ…å†µ"

## ğŸ§© æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent Node (å†³ç­–å±‚)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tool (å·¥å…·å±‚)                      â”‚  â† @toolè£…é¥°çš„å‡½æ•°
â”‚   - å‚æ•°æ ¡éªŒ                         â”‚
â”‚   - HTTPè¯·æ±‚                         â”‚
â”‚   - ç»“æœæ ¼å¼åŒ–                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Service (è¿æ¥ç®¡ç†å±‚)               â”‚  â† ç®¡ç†HTTPå®¢æˆ·ç«¯
â”‚   - åˆå§‹åŒ–é…ç½®                       â”‚
â”‚   - æä¾›get_client()                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®¾å¤‡ç¡¬ä»¶ / å¤–éƒ¨API                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç‰¹æ€§

- **æ¸…æ™°åˆ†å±‚**ï¼šServiceè´Ÿè´£è¿æ¥ï¼ŒToolè´Ÿè´£æ“æ§é€»è¾‘
- **æ˜“äºæ‰©å±•**ï¼šæ–°å¢è®¾å¤‡åªéœ€æ·»åŠ èŠ‚ç‚¹+å·¥å…·+æç¤ºè¯
- **ä¸“å®¶é›†æˆ**ï¼šæ”¯æŒå¤–éƒ¨ä¸“å®¶ç³»ç»Ÿï¼Œæä¾›æ•°æ®æŸ¥è¯¢å’Œåˆ†æ
- **å¼‚æ­¥æ¶æ„**ï¼šå…¨å¼‚æ­¥å®ç°ï¼Œé«˜å¹¶å‘æ”¯æŒ

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°è®¾å¤‡ç±»å‹

1. **æ·»åŠ æšä¸¾** (`enums/device_type.py`)
2. **åˆ›å»ºService** (`services/xxx_service.py`)
3. **åˆ›å»ºTools** (`tools/xxx_tools.py`)
4. **åˆ›å»ºæç¤ºè¯** (`prompts/xxx_agent_prompt.md`)
5. **åˆ›å»ºèŠ‚ç‚¹** (`graph/device_nodes.py`)
6. **æ³¨å†Œå·¥å…·** (`tools/tool_provider.py`)
7. **æ›´æ–°è·¯ç”±** (`graph/builder.py`)

### æ·»åŠ æ–°å·¥å…·

```python
# tools/xxx_tools.py
from langchain_core.tools import tool
from services.xxx_service import xxx_service

@tool
async def your_tool(param1: str, param2: int) -> str:
    """å·¥å…·æè¿°"""
    client = await xxx_service.get_client()
    response = await client.post("/api/action", json={...})
    return f"æ“ä½œç»“æœ: {response.json()}"
```

## ğŸ“ æ—¥å¿—

æ—¥å¿—æ–‡ä»¶ä½äº `logs/` ç›®å½•ï¼š

- `deviceagent.log`: æ‰€æœ‰æ—¥å¿—
- `error.log`: é”™è¯¯æ—¥å¿—

## ğŸ§ª æµ‹è¯•

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# æŸ¥çœ‹APIæ–‡æ¡£
open http://localhost:8000/docs
```

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…ã€‚
